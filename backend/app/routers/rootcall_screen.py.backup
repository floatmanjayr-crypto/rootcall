import os
import logging
from typing import Optional
from fastapi import APIRouter, Request, Response
from app.services.client_config import get_client_config
import httpx

log = logging.getLogger("badbot")
router = APIRouter(prefix="/telnyx/badbot", tags=["BadBot Screen"])

TELNYX_API_KEY = os.getenv("TELNYX_API_KEY", "").strip()
TELNYX_SMS_FROM = os.getenv("TELNYX_SMS_FROM", "").strip()
DRY_RUN = os.getenv("BADBOT_DRY_RUN", "").strip() == "1"

# Telnyx webhook signature verification (optional but recommended)
TELNYX_PUBLIC_KEY = os.getenv("TELNYX_PUBLIC_KEY", "").strip()

def verify_telnyx_signature(request: Request, body: bytes):
    """Verify Telnyx webhook signature - currently disabled for testing"""
    # TODO: Implement signature verification for production
    # For now, we'll allow all requests for testing
    return True

async def telnyx_answer(ccid: str):
    """Answer the incoming call"""
    if DRY_RUN:
        log.info("[DRY_RUN] answer ccid=%s", ccid)
        return {"ok": True, "dry_run": True}
    
    if not TELNYX_API_KEY:
        log.error("Missing TELNYX_API_KEY")
        return {"error": "Missing API key"}
    
    url = f"https://api.telnyx.com/v2/calls/{ccid}/actions/answer"
    async with httpx.AsyncClient(timeout=10) as client:
        try:
            r = await client.post(
                url,
                headers={"Authorization": f"Bearer {TELNYX_API_KEY}"},
                json={}
            )
            log.info("Answer response: %s", r.status_code)
            return r.json() if r.text else {"ok": True}
        except Exception as e:
            log.error("Answer error: %s", e)
            return {"error": str(e)}

async def telnyx_transfer(ccid: str, to: str):
    """Transfer call to destination"""
    if DRY_RUN:
        log.info("[DRY_RUN] transfer ccid=%s to=%s", ccid, to)
        return {"ok": True, "dry_run": True}
    
    if not TELNYX_API_KEY:
        log.error("Missing TELNYX_API_KEY")
        return {"error": "Missing API key"}
    
    url = f"https://api.telnyx.com/v2/calls/{ccid}/actions/transfer"
    async with httpx.AsyncClient(timeout=10) as client:
        try:
            r = await client.post(
                url,
                headers={"Authorization": f"Bearer {TELNYX_API_KEY}"},
                json={"to": to}
            )
            log.info("Transfer response: %s", r.status_code)
            return r.json() if r.text else {"ok": True}
        except Exception as e:
            log.error("Transfer error: %s", e)
            return {"error": str(e)}

async def telnyx_hangup(ccid: str):
    """Hangup the call"""
    if DRY_RUN:
        log.info("[DRY_RUN] hangup ccid=%s", ccid)
        return {"ok": True, "dry_run": True}
    
    if not TELNYX_API_KEY:
        return
    
    url = f"https://api.telnyx.com/v2/calls/{ccid}/actions/hangup"
    async with httpx.AsyncClient(timeout=10) as client:
        try:
            await client.post(
                url,
                headers={"Authorization": f"Bearer {TELNYX_API_KEY}"},
                json={}
            )
        except Exception as e:
            log.error("Hangup error: %s", e)

def send_sms_alert(to_number: str, message: str):
    """Send SMS alert to client"""
    if DRY_RUN:
        log.info("[DRY_RUN] SMS to %s: %s", to_number, message)
        return
    
    if not TELNYX_API_KEY or not TELNYX_SMS_FROM:
        log.warning("Cannot send SMS: missing credentials")
        return
    
    try:
        import requests
        requests.post(
            "https://api.telnyx.com/v2/messages",
            headers={"Authorization": f"Bearer {TELNYX_API_KEY}"},
            json={
                "from": TELNYX_SMS_FROM,
                "to": to_number,
                "text": message
            },
            timeout=10
        )
    except Exception as e:
        log.error("SMS send error: %s", e)

@router.post("/webhook", status_code=200)
async def screen_call(request: Request):
    """
    Main BadBot screening webhook - NO AUTHENTICATION REQUIRED
    This endpoint receives webhooks directly from Telnyx
    """
    
    # Log the incoming request
    client_ip = request.client.host if request.client else "unknown"
    log.info("[WEBHOOK] Received from IP: %s", client_ip)
    
    # Get raw body for signature verification
    try:
        raw_body = await request.body()
        body = await request.json()
        log.info("[WEBHOOK] Event received: %s", body.get("data", {}).get("event_type", "unknown"))
    except Exception as e:
        log.error("[WEBHOOK] Failed to parse body: %s", e)
        return {"error": "Invalid JSON", "status": "error"}
    
    # Optional: Verify Telnyx signature (disabled for testing)
    # if not verify_telnyx_signature(request, raw_body):
    #     log.warning("[WEBHOOK] Signature verification failed")
    #     return {"error": "Invalid signature", "status": "unauthorized"}
    
    data = body.get("data", {})
    evt = data.get("event_type", "")
    payload = data.get("payload", {})
    
    ccid = payload.get("call_control_id")
    from_num = (payload.get("from") or {}).get("phone_number", "")
    to_num = (payload.get("to") or {}).get("phone_number", "")
    cnam = payload.get("caller_id_name", "")
    
    log.info("[CALL] Event: %s | From: %s | To: %s | CCID: %s", evt, from_num, to_num, ccid)
    
    if not ccid:
        log.warning("[WEBHOOK] No call_control_id found")
        return {"status": "no_ccid"}
    
    # Get client config
    cfg = get_client_config(to_num)
    if not cfg:
        log.warning("[CONFIG] No config for number: %s", to_num)
        return {"status": "no_config", "telnyx_number": to_num}
    
    # Handle call.initiated - Answer immediately
    if evt == "call.initiated":
        log.info("[INITIATED] Answering call")
        result = await telnyx_answer(ccid)
        return {"status": "answered", "result": result}
    
    # Handle call.answered - Route the call
    if evt == "call.answered":
        client_cell = cfg.get("client_cell", "")
        trusted = cfg.get("trusted_contacts", [])
        retell_did = cfg.get("retell_did", "")
        caregiver = cfg.get("caregiver_cell", "")
        
        # 1) Check for spam
        spam_keywords = ["spam", "scam", "fraud", "robocall", "telemarketer"]
        if any(keyword in cnam.lower() for keyword in spam_keywords):
            log.warning("[SPAM] Blocked: %s (%s)", from_num, cnam)
            send_sms_alert(client_cell, f"[BadBot] Blocked spam: {from_num}")
            if caregiver:
                send_sms_alert(caregiver, f"[BadBot] Blocked spam for client: {from_num}")
            await telnyx_hangup(ccid)
            return {"status": "spam_blocked", "from": from_num}
        
        # 2) Check if trusted
        if from_num in trusted:
            log.info("[TRUSTED] Forwarding %s to %s", from_num, client_cell)
            if client_cell:
                result = await telnyx_transfer(ccid, client_cell)
                return {"status": "trusted_forwarded", "from": from_num, "to": client_cell, "result": result}
        
        # 3) Unknown -> Send to Retell
        if retell_did:
            log.info("[UNKNOWN] Transferring %s to Retell: %s", from_num, retell_did)
            result = await telnyx_transfer(ccid, retell_did)
            return {"status": "retell_transfer", "from": from_num, "retell_did": retell_did, "result": result}
        
        # 4) Fallback - forward with alert
        if client_cell:
            log.info("[FALLBACK] Forwarding %s to %s", from_num, client_cell)
            send_sms_alert(client_cell, f"[BadBot] Unknown caller {from_num} forwarded")
            result = await telnyx_transfer(ccid, client_cell)
            return {"status": "unknown_forwarded", "from": from_num, "to": client_cell, "result": result}
        
        log.warning("[NO_CONFIG] No routing configured")
        return {"status": "no_action_configured"}
    
    # Handle hangup events
    if evt in ("call.hangup", "call.ended", "call.hangup.completed"):
        log.info("[ENDED] Call ended: %s", evt)
        return {"status": "ok", "event": evt}
    
    # All other events
    log.info("[OTHER] Event: %s", evt)
    return {"status": "ignored", "event": evt}

@router.get("/health")
async def health_check():
    """Health check - no auth required"""
    return {
        "status": "ok",
        "service": "BadBot Call Screening",
        "dry_run": DRY_RUN,
        "has_api_key": bool(TELNYX_API_KEY)
    }

@router.get("/debug")
async def debug_info():
    """Debug info - no auth required"""
    from app.services.client_config import CLIENT_LINES
    return {
        "dry_run": DRY_RUN,
        "has_telnyx_key": bool(TELNYX_API_KEY),
        "has_sms_from": bool(TELNYX_SMS_FROM),
        "client_count": len(CLIENT_LINES),
        "telnyx_numbers": list(CLIENT_LINES.keys())
    }
