<!DOCTYPE html>
<html>
<head>
    <title>Choose Your Shield Number</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-[#f9f6f3] min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-10 border border-[#0d3d2f]/20">
            
            <!-- Header -->
            <div class="flex items-center gap-3 mb-8">
                <div class="w-12 h-12 bg-gradient-to-br from-emerald-700 to-emerald-500 rounded-full flex items-center justify-center">
                    <i class="fas fa-phone text-white text-xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-[#0d3d2f]">Choose Your Shield Number</h1>
            </div>

            <!-- STEP 1 — Select State -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-[#0d3d2f] mb-2">
                    Select State
                </label>
                <select id="state-select" onchange="loadAreaCodes()"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg 
                               focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="">-- Select State --</option>
                </select>
            </div>

            <!-- STEP 2 — Area Codes -->
            <div id="area-code-section" class="mb-6 hidden">
                <label class="block text-sm font-semibold text-[#0d3d2f] mb-2">
                    Select Area Code
                </label>
                <select id="area-code-select"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg 
                               focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                </select>

                <button onclick="searchByAreaCode()"
                        class="mt-4 px-6 py-3 bg-[#0d3d2f] text-white rounded-lg hover:bg-emerald-700 font-semibold">
                    Search Numbers
                </button>
            </div>

            <!-- STEP 3 — ZIP Proximity Search -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-[#0d3d2f] mb-2">
                    Or Search Closest Number by ZIP Code
                </label>
                <div class="flex gap-2">
                    <input type="text" id="zip-input" maxlength="5"
                           class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg 
                                  focus:ring-2 focus:ring-emerald-500"
                           placeholder="33025">

                    <button onclick="searchByZip()"
                            class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-semibold">
                        Find Closest Number
                    </button>
                </div>
            </div>

            <!-- RESULTS -->
            <div id="results" class="space-y-4 mt-10"></div>
        </div>
    </div>

    <script>
        const API = "http://localhost:8000";
        const user = JSON.parse(localStorage.getItem("user"));

        // Load state list on page load
        document.addEventListener("DOMContentLoaded", () => {
            const states = {
                "AL": "Alabama", "AK": "Alaska", "AZ": "Arizona", "AR": "Arkansas",
                "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware",
                "FL": "Florida", "GA": "Georgia", "HI": "Hawaii", "ID": "Idaho",
                "IL": "Illinois", "IN": "Indiana", "IA": "Iowa", "KS": "Kansas",
                "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MD": "Maryland",
                "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi",
                "MO": "Missouri", "MT": "Montana", "NE": "Nebraska", "NV": "Nevada",
                "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico",
                "NY": "New York", "NC": "North Carolina", "ND": "North Dakota",
                "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PA": "Pennsylvania",
                "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota",
                "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont",
                "VA": "Virginia", "WA": "Washington", "WV": "West Virginia",
                "WI": "Wisconsin", "WY": "Wyoming"
            };

            const stateSelect = document.getElementById("state-select");
            Object.entries(states).forEach(([code, name]) => {
                stateSelect.innerHTML += `<option value="${code}">${name}</option>`;
            });
        });

        // Load area codes from backend
        async function loadAreaCodes() {
            const state = document.getElementById("state-select").value;
            if (!state) return;

            const res = await fetch(`${API}/api/numbers/area-codes/${state}`);
            const areas = await res.json();

            const section = document.getElementById("area-code-section");
            const areaSelect = document.getElementById("area-code-select");

            section.classList.remove("hidden");
            areaSelect.innerHTML = areas.map(a => `<option value="${a}">${a}</option>`).join("");
        }

        // Search by area code
        async function searchByAreaCode() {
            const area = document.getElementById("area-code-select").value;
            const res = await fetch(`${API}/api/numbers/search`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ area_code: area, limit: 20 })
            });

            const data = await res.json();
            displayResults(data.numbers);
        }

        // Search by ZIP proximity
        async function searchByZip() {
            const zip = document.getElementById("zip-input").value;
            if (zip.length !== 5) {
                alert("Enter a valid 5-digit ZIP code");
                return;
            }

            const res = await fetch(`${API}/api/numbers/search-closest-zip`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ zip })
            });

            const data = await res.json();
            displayResults(data.numbers);
        }

        // Render numbers
        function displayResults(numbers) {
            const results = document.getElementById("results");

            if (!numbers.length) {
                results.innerHTML = `<p class="text-center text-gray-600">No numbers found.</p>`;
                return;
            }

            results.innerHTML = numbers
                .map(num => `
                <div class="border-2 border-[#0d3d2f]/20 rounded-xl p-5 flex justify-between items-center bg-white hover:shadow-xl transition">
                    <div>
                        <div class="text-2xl font-bold text-[#0d3d2f]">${num.phone_number}</div>
                        <div class="text-sm text-gray-600">${num.region} • $${num.cost}/month</div>
                    </div>
                    <button onclick="purchaseNumber('${num.phone_number}')"
                            class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 font-bold">
                        Buy
                    </button>
                </div>
            `)
                .join("");
        }

        // Purchase
        async function purchaseNumber(phoneNumber) {
            const nickname = prompt("Give this shield number a nickname:");
            if (!nickname) return;

            const res = await fetch(`${API}/api/numbers/purchase`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    phone_number: phoneNumber,
                    user_id: user.id,
                    nickname
                })
            });

            const data = await res.json();

            if (res.ok) {
                alert("Shield number purchased!");
                window.location.href = "/static/client-portal.html";
            } else {
                alert("Error: " + data.detail);
            }
        }
    </script>
</body>
</html>
