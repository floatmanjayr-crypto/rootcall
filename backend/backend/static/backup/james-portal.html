<!DOCTYPE html>
<html>
<head>
    <title>James Smith - RootCall Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6 max-w-6xl">
        <div class="bg-blue-600 text-white p-6 rounded-lg mb-6">
            <h1 class="text-3xl font-bold">James Smith Protection Portal</h1>
            <p class="text-lg">+18135478530</p>
        </div>
        
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Spam Blocked</div>
                <div class="text-3xl font-bold text-red-600" id="spam-blocked">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Calls Screened</div>
                <div class="text-3xl font-bold text-yellow-600" id="calls-screened">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Trusted Connected</div>
                <div class="text-3xl font-bold text-green-600" id="trusted-connected">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="text-sm text-gray-600">Total Calls</div>
                <div class="text-3xl font-bold text-blue-600" id="total-calls">0</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <h2 class="text-2xl font-bold mb-4">Alert Settings</h2>
            <div id="config-status" class="mb-4 p-3 bg-gray-100 rounded text-sm"></div>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <label class="block text-sm font-semibold mb-2">Alert Phone Number:</label>
                <div class="flex gap-2">
                    <input type="tel" id="client-cell" class="flex-1 px-4 py-2 border rounded-lg" placeholder="+17543670370">
                    <button onclick="updatePhone()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        Update
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <label class="flex items-center">
                    <input type="checkbox" id="sms-alerts" class="mr-3 w-5 h-5">
                    <span class="text-lg">Enable SMS Alerts</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="alert-spam" class="mr-3 w-5 h-5">
                    <span class="text-lg">Alert on Spam</span>
                </label>
                <label class="flex items-center">
                    <input type="checkbox" id="alert-unknown" class="mr-3 w-5 h-5">
                    <span class="text-lg">Alert on Unknown</span>
                </label>
                <button onclick="saveSettings()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Settings
                </button>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Trusted Contacts</h2>
            <div class="flex gap-2 mb-4">
                <input type="tel" id="new-contact" placeholder="+1234567890" class="flex-1 px-4 py-3 border rounded-lg">
                <input type="text" id="new-contact-name" placeholder="Name" class="flex-1 px-4 py-3 border rounded-lg">
                <button onclick="addContact()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Add
                </button>
            </div>
            <div id="contacts-list" class="space-y-2"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Recent Calls</h2>
                <a href="https://rootcall.onrender.com/api/rootcall/export/1" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    Export CSV
                </a>
            </div>
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 text-left">Time</th>
                        <th class="px-4 py-2 text-left">From</th>
                        <th class="px-4 py-2 text-left">Caller ID</th>
                        <th class="px-4 py-2 text-left">Action</th>
                        <th class="px-4 py-2 text-left">Status</th>
                    </tr>
                </thead>
                <tbody id="call-history"></tbody>
            </table>
        </div>
    </div>

    <script>
        const CLIENT_ID = 1;
        const API = 'https://rootcall.onrender.com/api/rootcall';

        async function loadData() {
            try {
                const stats = await fetch(`${API}/stats/${CLIENT_ID}`).then(r => r.json());
                document.getElementById('spam-blocked').textContent = stats.spam_blocked;
                document.getElementById('calls-screened').textContent = stats.calls_screened;
                document.getElementById('trusted-connected').textContent = stats.trusted_forwarded;
                document.getElementById('total-calls').textContent = stats.total_calls;

                const configRes = await fetch(`${API}/config/${CLIENT_ID}`);
                if (configRes.ok) {
                    const config = await configRes.json();
                    document.getElementById('config-status').innerHTML = `<strong>Connected:</strong> ${config.client_name} | ${config.client_cell}`;
                    document.getElementById('sms-alerts').checked = config.sms_alerts_enabled;
                    document.getElementById('alert-spam').checked = config.alert_on_spam;
                    document.getElementById('alert-unknown').checked = config.alert_on_unknown;
                    document.getElementById('client-cell').value = config.client_cell || '';

                    const list = document.getElementById('contacts-list');
                    list.innerHTML = '';
                    if (config.trusted_contacts && config.trusted_contacts.length > 0) {
                        config.trusted_contacts.forEach(c => {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg';
                            div.innerHTML = `
                                <div>
                                    <div class="font-bold">${c.name || 'Unnamed'}</div>
                                    <div class="text-gray-600">${c.phone_number}</div>
                                </div>
                                <button onclick="removeContact('${c.phone_number}')" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded">Remove</button>
                            `;
                            list.appendChild(div);
                        });
                    } else {
                        list.innerHTML = '<p class="text-gray-500 italic">No trusted contacts</p>';
                    }
                }

                const callsRes = await fetch(`${API}/calls/${CLIENT_ID}`);
                if (callsRes.ok) {
                    const calls = await callsRes.json();
                    const tbody = document.getElementById('call-history');
                    tbody.innerHTML = '';
                    
                    const statusColors = {
                        'blocked': 'bg-red-100 text-red-800',
                        'screening': 'bg-yellow-100 text-yellow-800',
                        'answered': 'bg-green-100 text-green-800'
                    };
                    
                    calls.forEach(call => {
                        const tr = document.createElement('tr');
                        tr.className = 'border-t hover:bg-gray-50';
                        tr.innerHTML = `
                            <td class="px-4 py-3">${new Date(call.timestamp).toLocaleString()}</td>
                            <td class="px-4 py-3 font-medium">${call.from_number}</td>
                            <td class="px-4 py-3">${call.caller_name}</td>
                            <td class="px-4 py-3">${call.action.replace('_', ' ')}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${statusColors[call.status]}">${call.status}</span></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    if (calls.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No calls yet - make a test call!</td></tr>';
                    }
                }
            } catch (e) {
                console.error('Error:', e);
            }
        }

        async function updatePhone() {
            const newNumber = document.getElementById('client-cell').value;
            if (!newNumber.startsWith('+')) return alert('Use format: +1234567890');
            try {
                await fetch(`${API}/config/${CLIENT_ID}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({client_cell: newNumber})
                });
                alert('Phone updated!');
                loadData();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function saveSettings() {
            try {
                await fetch(`${API}/config/${CLIENT_ID}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sms_alerts_enabled: document.getElementById('sms-alerts').checked,
                        alert_on_spam: document.getElementById('alert-spam').checked,
                        alert_on_unknown: document.getElementById('alert-unknown').checked
                    })
                });
                alert('Settings saved!');
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function addContact() {
            const phone = document.getElementById('new-contact').value;
            const name = document.getElementById('new-contact-name').value;
            if (!phone) return;
            try {
                await fetch(`${API}/trusted-contacts/${CLIENT_ID}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({phone_number: phone, name: name})
                });
                document.getElementById('new-contact').value = '';
                document.getElementById('new-contact-name').value = '';
                loadData();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function removeContact(phone) {
            if (!confirm(`Remove ${phone}?`)) return;
            try {
                await fetch(`${API}/trusted-contacts/${CLIENT_ID}/${encodeURIComponent(phone)}`, {method: 'DELETE'});
                loadData();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
